<link rel="import" href="../polymer/polymer.html">

<script>
  window.mtz = window.mtz || {};

  /**
   * A behavior for downloading streamed files or creating files based on available data.
   *
   * @polymerBehavior
   * @demo demo/index.html
   */
  mtz.FileDownloadBehavior = {

    /**
     * Converts the data to a blob then uses navigator to save blob if itâ€™s available, otherwise
     * creates an <a> with [download] attribute then simulates a click.
     * @param {String} data - data to encode.
     * @param {String} type - type of file to generate (i.e, text/json).
     * @param {String} [name = 'download'] - file name to save data under..
     */
    downloadFromData(data, type, name = 'download') {
      const blob = new Blob([decodeURIComponent(encodeURI(data))], {type});
      if(window.navigator && window.navigator.msSaveOrOpenBlob) {
        window.navigator.msSaveOrOpenBlob(blob, name);
      } else {
        // Link elements have a download attribute which provides cross-platform
        // download behavior supporting all but IE 11. This creates new link and then
        // clicks it to initiate download.
        const link = document.createElement('a');
        link.className = 'file-download';
        link.href = (window.URL || window.webkitURL).createObjectURL(blob);
        link.download = name;
        document.body.appendChild(link);
        link.click();
      }
    },

    /**
     * Opens a new tab at the URI so that download can be initiated from the page.
     * @param {String} uri - The uri to open.
     * @param {Boolean} [newTab = true] - If false, downloads uri in existing tab. Otherwise,
     * downloads in new tab.
     * @return {Boolean} Returns true.
     */
    downloadFromURI(uri, newTab = true) {
      window.open(uri, newTab ? '_blank' : '_self');
      return true; // NOTE: Returning true to prevent error in some browsers during download.
    }
  };
</script>
