<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>mtz-file-download-behavior test</title>

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>

    <link rel="import" href="../mtz-file-download-behavior.html">
  </head>
  <body>
    <test-fixture id="basic">
      <template>
        <file-downloader></file-downloader>
      </template>
    </test-fixture>

    <dom-module id="file-downloader">
      <template>
        <button on-click="openUriInNewTab">Open In New Tab</button>
        <button on-click="openUriInCurrentTab">Open In Current Tab</button>
        <button on-click="createFile">Create File</button>
      </template>
      <script>
        window.addEventListener('WebComponentsReady', () => {
          Polymer({
            is: 'file-downloader',
            behaviors: [
              mtz.FileDownloadBehavior
            ]
          });
        });
      </script>
    </dom-module>

    <script>
      describe('mtz-file-download-behavior', () => {
        let element;

        beforeEach(() => {
          element = fixture('basic');
        });

        describe('public', () => {
          describe('downloadFromData', () => {
            it('should initiate download the data using msSaveOrOpenBlob if navigator is detected', () => {
              window.navigator.msSaveOrOpenBlob = sinon.spy()
              element.downloadFromData('Some amazing data string.', 'text/plain', 'newFile');
              expect(window.navigator.msSaveOrOpenBlob).to.be.called;
            });
            it('should download the data using link tag if navigator is not found', () => {
              const linkElement = {};
              linkElement.click = sinon.spy();
              window.navigator.msSaveOrOpenBlob = undefined;
              sinon.stub(window.document, 'createElement').withArgs('a').returns(linkElement);
              window.document.body.appendChild = sinon.spy();
              element.downloadFromData('Some amazing data string.', 'text/plain', 'sweet-name');
              expect(linkElement.className).to.equal('file-download');
              expect(linkElement.href).to.be.a('string');
              expect(linkElement.download).to.equal('sweet-name');
              expect(linkElement.click).to.be.called;
            });
            it('should default name to "download" if none is provided', () => {
              const data = 'Some amazing data string.';
              const type = 'text/plain';
              window.navigator.msSaveOrOpenBlob = sinon.spy()
              element.downloadFromData(data, type);
              // Get the download argument from the spy
              const fileNameArg = window.navigator.msSaveOrOpenBlob.getCall(0).args[1];
              expect(fileNameArg).to.equal('download');
            });
          });
          describe('downloadFromURI', () => {
            let uri;

            beforeEach(() => {
              uri = "some/amazing/uri.txt";
            });

            it('should open the document in the current tab if newTab is false', () => {
              window.open = sinon.spy();
              element.downloadFromURI(uri, false);
              expect(window.open).to.be.calledWithMatch(uri, '_self');
            });
            it('should open the document in the current tab if newTab is true', () => {
              window.open = sinon.spy();
              element.downloadFromURI(uri, true);
              expect(window.open).to.be.calledWithMatch(uri, '_blank');
            });
            it('should return true to preserve compatibility with numerous browsers', () => {
              window.open = sinon.spy();
              expect(element.downloadFromURI(uri, true)).to.equal(true);
            });
            it('should default current tab if no explicit value is provided', () => {
              window.open = sinon.spy();
              element.downloadFromURI(uri);
              // Grab argument to window.open corresponding to true newTab
              const actualArgument = window.open.getCall(0).args[1];
              expect(actualArgument).to.equal('_blank');
            });
          });
        });
      });
    </script>
  </body>
</html>
